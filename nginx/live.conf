# GEL3 Website Nginx config
# This needs to be deploy manually to nginx if change are made
# See DEPLOY.md in https://github.com/WestpacGEL/GEL


# settings
#
server_tokens  off;

# prevent click jacking attacks
add_header  X-Frame-Options SAMEORIGIN;

# disallow circumventing declared MIME types
add_header  X-Content-Type-Options nosniff;

# X-XSS-Protection
add_header  X-XSS-Protection '1; mode=block';

# HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)
add_header  Strict-Transport-Security 'max-age=31536000; includeSubDomains;' always;

# Content Security Policy
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' data: https://ssl.google-analytics.com https://cdn.polyfill.io https://www.gstatic.com https://gateway.zscloud.net; img-src 'self' data: https://ssl.google-analytics.com https://res.cloudinary.com/; connect-src 'self' https://ssl.google-analytics.com; style-src 'self' 'unsafe-inline' https://www.gstatic.com; font-src 'self' data: https://fonts.gstatic.com; frame-src 'self' https://www.youtube.com https://player.vimeo.com https://gateway.zscloud.net; object-src 'none'";

# CORS
add_header  'Access-Control-Allow-Origin' '*';
add_header  'Access-Control-Allow-Credentials' 'true';
add_header  'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
add_header  'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';


# http to https redirect
#
server {
	listen       80;
	server_name  gel.westpacgroup.com.au;
	return 301   https://$host$request_uri;
}


# ssl and http2 config
#
server {
	listen       443 ssl http2;
	listen       [::]:443 ssl http2;
	server_name  gel.westpacgroup.com.au;
	root         /var/www/html/;

	ssl on;
	ssl_certificate      /etc/letsencrypt/live/gel.westpacgroup.com.au/fullchain.pem;
	ssl_certificate_key  /etc/letsencrypt/live/gel.westpacgroup.com.au/privkey.pem;

	ssl_session_timeout  1d;
	ssl_session_cache    shared:SSL:50m;
	ssl_session_tickets  off;

	ssl_protocols              TLSv1 TLSv1.1 TLSv1.2;
	ssl_prefer_server_ciphers  on;
	ssl_dhparam                /etc/nginx/ssl/dhparam.pem;
	ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';

	# OCSP Stapling ---
	# fetch OCSP records from URL in ssl_certificate and cache them
	ssl_stapling         on;
	ssl_stapling_verify  on;


	# Keystone GEL3 website routes
	# -----------------------------------------

	# Website: /gel > localhost:3000
	# CMS: /admin > localhost:3000/admin
	# GraphQL: /graphql > localhost:3000/admin/api

	location /gel {
		root   /var/www/html/;
		proxy_pass              http://localhost:3000;
		proxy_redirect          http://localhost:3000/  /gel/;

		proxy_pass_header       Server;
		proxy_set_header        X-Real-IP $remote_addr;
		proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header        X-Scheme $scheme;
		proxy_set_header        Host $http_host;
		proxy_set_header        X-NginX-Proxy true;
		proxy_connect_timeout   5;
		proxy_read_timeout      240;
		proxy_intercept_errors  off;

		# Put server in maintenance mode if page exists
		if (-f $document_root/construction.html) {
			return 503;
		}
	}
	location /admin {
		root   /var/www/html/;
		proxy_pass              http://localhost:3000/admin;
		proxy_redirect          http://localhost:3000/admin  /admin/;

		proxy_pass_header       Server;
		proxy_set_header        X-Real-IP $remote_addr;
		proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header        X-Scheme $scheme;
		proxy_set_header        Host $http_host;
		proxy_set_header        X-NginX-Proxy true;
		proxy_connect_timeout   5;
		proxy_read_timeout      240;
		proxy_intercept_errors  off;

		# Put server in maintenance mode if page exists
		if (-f $document_root/construction.html) {
			return 503;
		}
	}
	location /graphql {
		root   /var/www/html/;
		proxy_pass              http://localhost:3000/admin/api;
		proxy_redirect          http://localhost:3000/admin/api/  /graphql/;

		proxy_pass_header       Server;
		proxy_set_header        X-Real-IP $remote_addr;
		proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header        X-Scheme $scheme;
		proxy_set_header        Host $http_host;
		proxy_set_header        X-NginX-Proxy true;
		proxy_connect_timeout   5;
		proxy_read_timeout      240;
		proxy_intercept_errors  off;

		# Put server in maintenance mode if page exists
		if (-f $document_root/construction.html) {
			return 503;
		}
	}

	# -----------------------------------------
	# END Keystone GEL3 website routes


	# blender server
	#
	location /api/blender/ {
		root   /var/www/html/;
		proxy_pass              http://localhost:1337;
		proxy_redirect          http://localhost:1337/  /api/blender/;

		proxy_redirect          off;
		proxy_pass_header       Server;
		proxy_set_header        X-Real-IP $remote_addr;
		proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header        X-Scheme $scheme;
		proxy_set_header        Host $http_host;
		proxy_set_header        X-NginX-Proxy true;
		proxy_connect_timeout   5;
		proxy_read_timeout      240;
		proxy_intercept_errors  on;

		# Put server in maintenance mode if page exists
		if (-f $document_root/construction.html) {
			return 503;
		}

		# error pages
		error_page  400          /blender-error.html;
		error_page  401          /blender-error.html;
		error_page  402          /blender-error.html;
		error_page  403          /blender-error.html;
		error_page  404          /blender-error.html;
		error_page  500 502 504  /blender-error.html;
		error_page  503          @maintenance;
	}


	# status server
	#
	location /api/status/ {
		root   /var/www/html/;
		proxy_pass              http://localhost:1338;
		proxy_redirect          http://localhost:1338/  /status/api/;

		proxy_redirect          off;
		proxy_pass_header       Server;
		proxy_set_header        X-Real-IP $remote_addr;
		proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header        X-Scheme $scheme;
		proxy_set_header        Host $http_host;
		proxy_set_header        X-NginX-Proxy true;
		proxy_connect_timeout   5;
		proxy_read_timeout      240;
		proxy_intercept_errors  on;
	}


	# site server
	#
	location / {
		root   /var/www/html/;
		index  index.html index.htm;

		# Put server in maintenance mode if page exists
		if (-f $document_root/construction.html) {
			return 503;
		}

		# error pages
		error_page  400          /error400/index.html;
		error_page  401          /error401/index.html;
		error_page  402          /error402/index.html;
		error_page  403          /error403/index.html;
		error_page  404          /error404/index.html;
		error_page  500 502 504  /error500/index.html;
		error_page  503          @maintenance;

		location = /error404/index.html {
			internal;
		}
	}


	# redirect server error pages to the static error pages
	#
	location /GUI/BOM {
		# Put server in maintenance mode if page exists
		if (-f $document_root/construction.html) {
			return 503;
		}

		error_page  400          /GUI/BOM/error400/index.html;
		error_page  401          /GUI/BOM/error401/index.html;
		error_page  402          /GUI/BOM/error402/index.html;
		error_page  403          /GUI/BOM/error403/index.html;
		error_page  404          /GUI/BOM/error404/index.html;
		error_page  500 502 504  /GUI/BOM/error500/index.html;
		error_page  503          @maintenance;

		location = /GUI/BOM/error404/index.html {
			internal;
		}
	}

	location /GUI/BSA {
		# Put server in maintenance mode if page exists
		if (-f $document_root/construction.html) {
			return 503;
		}

		error_page  400          /GUI/BSA/error400/index.html;
		error_page  401          /GUI/BSA/error401/index.html;
		error_page  402          /GUI/BSA/error402/index.html;
		error_page  403          /GUI/BSA/error403/index.html;
		error_page  404          /GUI/BSA/error404/index.html;
		error_page  500 502 504  /GUI/BSA/error500/index.html;
		error_page  503          @maintenance;

		location = /GUI/BSA/error404/index.html {
			internal;
		}
	}

	location /GUI/STG {
		# Put server in maintenance mode if page exists
		if (-f $document_root/construction.html) {
			return 503;
		}

		error_page  400          /GUI/STG/error400/index.html;
		error_page  401          /GUI/STG/error401/index.html;
		error_page  402          /GUI/STG/error402/index.html;
		error_page  403          /GUI/STG/error403/index.html;
		error_page  404          /GUI/STG/error404/index.html;
		error_page  500 502 504  /GUI/STG/error500/index.html;
		error_page  503          @maintenance;

		location = /GUI/STG/error404/index.html {
			internal;
		}
	}

	location /GUI/WBC {
		# Put server in maintenance mode if page exists
		if (-f $document_root/construction.html) {
			return 503;
		}

		error_page  400          /GUI/WBC/error400/index.html;
		error_page  401          /GUI/WBC/error401/index.html;
		error_page  402          /GUI/WBC/error402/index.html;
		error_page  403          /GUI/WBC/error403/index.html;
		error_page  404          /GUI/WBC/error404/index.html;
		error_page  500 502 504  /GUI/WBC/error500/index.html;
		error_page  503          @maintenance;

		location = /GUI/WBC/error404/index.html {
			internal;
		}
	}

	location /GUI/WBG {
		# Put server in maintenance mode if page exists
		if (-f $document_root/construction.html) {
			return 503;
		}

		error_page  400          /GUI/WBG/error400/index.html;
		error_page  401          /GUI/WBG/error401/index.html;
		error_page  402          /GUI/WBG/error402/index.html;
		error_page  403          /GUI/WBG/error403/index.html;
		error_page  404          /GUI/WBG/error404/index.html;
		error_page  500 502 504  /GUI/WBG/error500/index.html;
		error_page  503          @maintenance;

		location = /GUI/WBG/error404/index.html {
			internal;
		}
	}

	location /GUI/BT {
		# Put server in maintenance mode if page exists
		if (-f $document_root/construction.html) {
			return 503;
		}

		error_page  400          /GUI/BT/error400/index.html;
		error_page  401          /GUI/BT/error401/index.html;
		error_page  402          /GUI/BT/error402/index.html;
		error_page  403          /GUI/BT/error403/index.html;
		error_page  404          /GUI/BT/error404/index.html;
		error_page  500 502 504  /GUI/BT/error500/index.html;
		error_page  503          @maintenance;

		location = /GUI/BT/error404/index.html {
			internal;
		}
	}

	location /protoform {
		autoindex on;
	}

	# maintenance mode page
	location @maintenance {
		rewrite ^(.*)$  /construction.html break;
	}

	# deny access to all dot files except the .well-knows for letsencrypt
	#
	location ~ /\.(?!well-known).* {
		deny all;
		access_log off;
		log_not_found off;
	}
}
